<!DOCTYPE html>
<html>
<head>
    <title>OpenMCT</title>
    <script src="openmct/openmct.js"></script>
    <script src="plugins/ServerPlugin.js"></script>
    <script src="plugins/HistoryClient.js"></script>
</head>
<body>
    <script>
        function fetchConfig(callback) {
            fetch("/config")
            .then(response => response.json())
            .then(json => callback(null, json))
            .catch(error => callback(error, null));
        }

        function startOpenMct(config) {
            openmct.setAssetPath('openmct');
            openmct.install(openmct.plugins.LocalStorage());
            openmct.install(openmct.plugins.MyItems());
            openmct.install(openmct.plugins.UTCTimeSystem());
            openmct.time.clock('local', {start: -15 * 60 * 1000, end: 0});
            openmct.time.timeSystem('utc');
            openmct.install(openmct.plugins.Espresso());

            openmct.serverPlugin = new ServerPlugin(config, config.metadata);
            openmct.historyClient = new HistoryClient();

            openmct.install(openmct.serverPlugin.installer);
            openmct.install(openmct.historyClient.installer);
           
            const ONE_YEAR = 365 * 24 * 60 * 60 * 1000;
            const ONE_MINUTE = 60 * 1000;

            openmct.time.addTimeSystem({
                key: 'local',
                name: 'Local Time',
                cssClass: 'icon-clock',
                timeFormat:  'utc',
                durationFormat:  'duration',
                isUTCBased:  true
            });

            openmct.install(openmct.plugins.Conductor({
                menuOptions: [
                    // 'Fixed' bounds mode configuation for the UTCTimeSystem
                    {
                        timeSystem: 'utc',
                        bounds: {start: Date.now() - 30 * ONE_MINUTE, end: Date.now()},
                        zoomOutLimit: ONE_YEAR,
                        zoomInLimit: ONE_MINUTE
                    },
                    // Configuration for the LocalClock in the UTC time system
                    {
                        clock: 'local',
                        timeSystem: 'utc',
                        clockOffsets: {start: - 30 * ONE_MINUTE, end: 0},
                        zoomOutLimit: ONE_YEAR,
                        zoomInLimit: ONE_MINUTE
                    },
                    //Configuration for the LocaLClock in the Local time system
                    {
                        clock: 'local',
                        timeSystem: 'local',
                        clockOffsets: {start: - 15 * ONE_MINUTE, end: 0}
                    }
                ]
            }));

            openmct.start();
        }

        fetchConfig((error, config) => {
            if (error) {
                console.log(error);
            } else {
                console.log(config);
                startOpenMct(config);
            }
        });
    </script>
</body>
</html>
